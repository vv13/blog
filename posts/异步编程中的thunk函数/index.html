<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="vv13">
    <meta name="description" content="vv13&#39;s personal website">
    <meta name="keywords" content="blog,developer,personal">

    <base href="https://vv13.cn">
    <title>
  å¼‚æ­¥ç¼–ç¨‹ä¸­çš„thunkå‡½æ•° Â· ğŸ¤ª
</title>

    <link rel="canonical" href="https://vv13.cn/posts/%E5%BC%82%E6%AD%A5%E7%BC%96%E7%A8%8B%E4%B8%AD%E7%9A%84thunk%E5%87%BD%E6%95%B0/">

    <link  rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:400,700">
    <link rel="stylesheet" href="//cdn.rawgit.com/necolas/normalize.css/master/normalize.css">
    <link rel="stylesheet" href="https://vv13.cn/css/style.min.css">

    

    

    <link rel="icon" type="image/png" href="https://vv13.cn/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://vv13.cn/images/favicon-16x16.png" sizes="16x16">

    

    <meta name="generator" content="Hugo 0.36" />
  </head>

  <body class="">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://vv13.cn">
      ğŸ¤ª
    </a>
    
    <ul class="navigation-list  float-right ">
      
      <li class="navigation-item">
        <a class="navigation-link" href="https://vv13.cn/posts/">Blog</a>
      </li>
      
      <li class="navigation-item">
        <a class="navigation-link" href="https://vv13.cn/about/">About</a>
      </li>
      
    </ul>
    
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
  <article>
    <header>
      <h1 class="title">å¼‚æ­¥ç¼–ç¨‹ä¸­çš„thunkå‡½æ•°</h1>
      <h2 class="date">August 23, 2017</h2>

      
    </header>

    

<h2 id="ä»€ä¹ˆæ˜¯thunk">ä»€ä¹ˆæ˜¯Thunk</h2>

<p>Thunkè‹±è¯‘å³è½¬åŒ–ç¨‹åºï¼Œç¬¬ä¸€æ¬¡é‡è§è¿™ä¸ªåè¯æ˜¯åœ¨ä½¿ç”¨redux-thunkçš„æ—¶å€™ï¼ŒåªçŸ¥é“æ˜¯åšä¸ºå¼‚æ­¥å’ŒåŒæ­¥ä¸­é—´ä»¶æ¥ä½¿ç”¨ï¼Œå¹¶æœªæ·±å…¥çš„äº†è§£ï¼Œæ¥ä¸‹æ¥å‘ç°koaçš„æ¡†æ¶ä¸­æ˜¯å› åœ¨koa1çš„æ¦‚å¿µä¸­è®¾è®¡åˆ°äº†å®ƒï¼Œæ•…å­¦ä¹ äº†ä¸€ç•ªï¼Œå› æ­¤åšä¸€ä¸ªç®€å•çš„æ€»ç»“ã€‚</p>

<p>å†™ä¸€ä¸ªç®€å•çš„å‡½æ•°ï¼Œç”¨äºè¯»å–package.jsonçš„ä¿¡æ¯ï¼š</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">fs.readFile(&#39;package.json&#39;, (err, data) =&gt; {
    if (err) throw err;
    console.log(data.toString())
})</pre></div>
<p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬éœ€è¦å°†å‚æ•°è¿›è¡ŒåŒ…è£…ä¸€ä¸‹ï¼Œæ¯”å¦‚åœ¨koa1çš„ç”Ÿæˆå™¨ä¸­é—´ä»¶ä¸­ï¼Œæˆ‘ä»¬å¿…é¡»å°†å‡½æ•°åŒ…è£…æˆæœ‰ä¸”åªæœ‰ä¸€ä¸ªcallbackå‡½æ•°ï¼Œè¿™æ ·koaä¸­é—´ä»¶æ‰èƒ½è¯†åˆ«å‡½æ•°ï¼š</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">const app = new Koa()

app.use(function*(next) {
    const data = yield readFileThunk(&#39;package.json&#39;)
    console.log(data)
    yield next
})

function readFileThunk(path, cb) {
    return function(cb) {
        fs.readFile(path, (err, data) =&gt; {
            if (err) throw err
            cb(null, data.toString())
        })
    }
}
app.listen(3000)</pre></div>
<p>é€šè¿‡è®¿é—®ç«¯å£ï¼Œæˆ‘ä»¬çœ‹åˆ°äº†æ­£ç¡®çš„æ‰“å°ä¿¡æ¯ï¼Œå°†æ­£å¸¸å‡½æ•°åŒ…è£…ä¸ºä¸Šè¿°å‡½æ•°ï¼Œå³ç§°ä¹‹ä¸ºthunkå‡½æ•°ã€‚<strong>Thunkå‡½æ•°å°†å¤šå‚æ•°å‡½æ•°æ›¿æ¢æˆäº†å•å‚æ•°ç‰ˆæœ¬</strong>ï¼Œä¸é«˜é˜¶å‡½æ•°ã€æŸ¯é‡ŒåŒ–æ€æƒ³ç±»ä¼¼ã€‚æ’­ä¸ªå°æ’æ›²ï¼Œåœ¨koa2ä¸­ï¼Œä¸­é—´ä»¶å†™æ³•æ›´è¿­æˆäº†async/awaitï¼Œå…¶åŸç†ä¹Ÿæ˜¯åŸºäºgeneratorè¿›è¡Œåˆä¸€æ¬¡å°è£…ï¼Œä»£ç ä¸ºï¼š</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">app.use(async(ctx, next) =&gt; {
    const data = await readFileWrap(&#39;package.json&#39;)
    console.log(data)
    await next()
})

function readFileWrap(path, cb) {
    return new Promise((resolve, reject) =&gt; {
        fs.readFile(path, (err, data) =&gt; {
            if (err) throw reject(error)
            resolve(data.toString())
        })
    })
}</pre></div>
<p>æˆ‘ä»¬æ¥ä¸‹æ¥è‡ªå·±å®ç°ä¸€ä¸ªç®€æ˜“çš„thunkå·¥å…·æ–¹æ³•ï¼Œæ€è·¯å¦‚ä¸‹ï¼š</p>

<ol>
<li>ä¸€å…±ä¸‰ä¸ªæ‰§è¡Œå‡½æ•°ï¼Œç¬¬ä¸€å±‚å‡½æ•°ä¼ å…¥ä¸»å‡½æ•°æ–¹æ³•fnï¼Œå¹¶è¿”å›ä¸€ä¸ªå¸¦æœ‰fnæ–¹æ³•çš„é—­åŒ…</li>
<li>ç¬¬äºŒå±‚å‡½æ•°ä¼ å…¥å‚æ•°argsï¼Œç„¶åè¿”å›ä¸€ä¸ªä»…éœ€ä¼ å…¥å›è°ƒå‡½æ•°ä¾›å¤–éƒ¨æ‰§è¡Œçš„æ–¹æ³•</li>
<li>ç¬¬ä¸‰å±‚å‡½æ•°ä¼ å…¥ä¸€ä¸ªå›è°ƒå‡½æ•°cb, ç„¶åæ‰§è¡Œä¸»ç¨‹åº</li>
</ol>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">function thunkit(fn) {
    return function() {
        var args = Array.prototype.slice.call(arguments) 
        return function(cb) {
            args.push(cb)
            return fn.apply(this, args)
        }
    }
}</pre></div>
<p>åœ¨å®é™…ä½¿ç”¨ä¸­ï¼Œå¾€å¾€ä¸šåŠ¡åœºæ™¯æ›´å¤æ‚ï¼Œå› æ­¤æ¨èä½¿ç”¨node-thunkifyåº“ï¼Œæºä»£ç ä¹Ÿåªæœ‰28è¡Œï¼Œè¯·çœ‹ä¸‹ä¸€èŠ‚ã€‚</p>

<h2 id="thunkifyæºç è§£æ">thunkifyæºç è§£æ</h2>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4">function thunkify(fn){
  assert(&#39;function&#39; == typeof fn, &#39;function required&#39;); // æ˜¯å¦ä¸ºå‡½æ•°

  return function(){
    var args = new Array(arguments.length); 
    var ctx = this; // ç»‘å®šå‡½æ•°çš„ä¸Šä¸‹æ–‡å¯¹è±¡
	
	// åˆå§‹åŒ–äº†ä¸€ä¸ªæ–°çš„æ•°ç»„ï¼Œè¿™ç§å†™æ³•å…¼å®¹æ€§æ›´å¼ºï¼Œä¸åƒæœ¬æ–‡ä¸Šé¢ç›´æ¥ç”¨çš„.sliceæ–¹æ³•è¿›è¡Œæ‹·è´æ•°ç»„
    for(var i = 0; i &lt; args.length; ++i) {
      args[i] = arguments[i];
    }

    return function(done){
      var called; // è®°å½•æ˜¯å¦æ‰§è¡Œå›è°ƒï¼Œåªå…è®¸æ‰§è¡Œä¸€æ¬¡

      args.push(function(){
        if (called) return;
        called = true;
        done.apply(null, arguments);
      });

      try {
        fn.apply(ctx, args); // è°ƒç”¨å‚æ•°åˆ—è¡¨
      } catch (err) {
        done(err); // è¿”å›é”™è¯¯
      }
    }
  }
};</pre></div>
<p>æºä»£ç å·²ç»å¤Ÿç®€å•äº†ï¼Œæƒ³ä¹Ÿæ— éœ€å¤šè¯´æ˜ï¼Œ<strong>é‡è¦çš„æ˜¯å‡½æ•°æœ¬èº«çš„æ€æƒ³ä¸çµæ´»çš„å»è¿ç”¨</strong>ã€‚</p>

<h3 id="å‚è€ƒèµ„æ–™">å‚è€ƒèµ„æ–™</h3>

<ul>
<li><p><a href="https://github.com/tj/node-thunkify">node-thunkify</a></p></li>

<li><p><a href="http://www.ruanyifeng.com/blog/2015/05/thunk.html">é˜®ä¸€å³°-Thunk å‡½æ•°çš„å«ä¹‰å’Œç”¨æ³•</a></p></li>

<li><p><a href="http://blog.stevensanderson.com/2013/12/21/experiments-with-koa-and-javascript-generators/">experiments-with-koa-and-javascript-generators</a></p></li>
</ul>

  </article>

  <br/>

  
  
</section>

      </div>

      <footer class="footer">
  <section class="container">
     Â© 2018  
  </section>
</footer>

    </main>

    

  </body>

</html>
